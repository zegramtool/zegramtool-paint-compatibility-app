<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¡—æ–™äº’æ›è¡¨æ¤œç´¢</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com; connect-src 'self'; img-src 'self' data:;">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .color-red { background-color: #ef4444; }
    .color-orange { background-color: #f97316; }
    .color-yellow { background-color: #eab308; }
    .color-green { background-color: #22c55e; }
    .color-blue { background-color: #3b82f6; }
    .color-purple { background-color: #a855f7; }
    .color-pink { background-color: #ec4899; }
    .color-brown { background-color: #a16207; }
    .color-gray { background-color: #6b7280; }
    .color-black { background-color: #1f2937; }
    .color-white { background-color: #f9fafb; border: 1px solid #d1d5db; }
    .color-default { background-color: #e5e7eb; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-overlay {
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      max-height: 90vh;
      overflow-y: auto;
    }
    
    /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .clickable-color {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .clickable-color:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">å¡—æ–™äº’æ›è¡¨æ¤œç´¢</h1>
    
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h2>
      <div class="space-y-4">
        <div>
          <input type="file" id="csv-file" accept=".csv" 
                 class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100">
        </div>
        <div id="file-status" class="text-sm">
          <div class="text-gray-600">
            <p>ğŸ“‹ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <p class="text-xs mt-1">å¯¾å¿œå½¢å¼: CSV (.csv)</p>
            <p class="text-xs text-blue-600">ğŸ’¡ æ–°å½¢å¼ã§ã¯å…¨ãƒ¡ãƒ¼ã‚«ãƒ¼ã®åŸè‰²ç‰¹æ€§ã«å¯¾å¿œã—ã¦ã„ã¾ã™</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="search" class="block text-sm font-medium text-gray-700 mb-2">æ¤œç´¢</label>
          <input type="text" id="search" placeholder="å“ç•ªãƒ»è‰²åãƒ»ã‚«ãƒ†ã‚´ãƒªã‚’æ¤œç´¢..." 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label for="category" class="block text-sm font-medium text-gray-700 mb-2">ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        
        <div>
          <label for="company" class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ã‚«ãƒ¼</label>
          <select id="company" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">ã™ã¹ã¦</option>
            <option value="kansai">é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆ</option>
            <option value="rock">ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆ</option>
            <option value="nippon">æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆ</option>
            <option value="isamu">ã‚¤ã‚µãƒ å¡—æ–™</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- çµæœã‚«ã‚¦ãƒ³ãƒˆ -->
    <div class="mb-4">
      <span id="result-count" class="text-lg font-semibold text-gray-700">æ¤œç´¢çµæœ: 0 ä»¶</span>
    </div>
    
    <!-- çµæœãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="no-results" class="hidden bg-white rounded-lg shadow-md p-8 text-center">
      <p class="text-gray-500 text-lg">è©²å½“ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>
    </div>
    
    <!-- ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º -->
    <div id="mobile-results" class="md:hidden space-y-4"></div>
    
    <!-- PCè¡¨ç¤º -->
    <div id="desktop-container" class="hidden md:block bg-white rounded-lg shadow-md overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç•ªå·</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ã‚«ãƒ†ã‚´ãƒª</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆ</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆ</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆ</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ã‚¤ã‚µãƒ å¡—æ–™</th>
            </tr>
          </thead>
          <tbody id="result-table" class="bg-white divide-y divide-gray-200">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl modal-content w-full max-w-md">
        <div class="flex justify-between items-center p-6 border-b">
          <h3 id="modal-title" class="text-lg font-semibold text-gray-800">è‰²ã®è©³ç´°æƒ…å ±</h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
        </div>
        <div class="p-6">
          <div id="modal-content" class="space-y-4">
            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹å†…å®¹ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let data = [];
    let currentFilteredData = [];
    
    // CSPå¯¾å¿œã®CSVè§£æé–¢æ•°
    function parseCSVText(csvText) {
      const lines = csvText.split('\n');
      if (lines.length === 0) return { data: [], meta: { fields: [] } };
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è§£æ
      const headers = lines[0].split(',').map(header => header.trim().replace(/\r$/, ''));
      
      // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è§£æ
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue; // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
        
        const values = parseCSVLine(line);
        if (values.length === 0) continue;
        
        const row = {};
        headers.forEach((header, index) => {
          let value = values[index] || '';
          value = value.trim().replace(/\r$/, '');
          
          if (value === '') {
            row[header] = null;
          } else if (header === 'ç•ªå·') {
            // ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æ•°å€¤å¤‰æ›
            row[header] = !isNaN(value) && !isNaN(parseFloat(value)) ? parseFloat(value) : value;
          } else {
            // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã™ã¹ã¦æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒï¼ˆå…ˆé ­ã‚¼ãƒ­ã‚’ç¶­æŒï¼‰
            row[header] = value;
          }
        });
        
        data.push(row);
      }
      
      return {
        data: data,
        meta: { fields: headers },
        errors: []
      };
    }
    
    // CSVè¡Œã‚’è§£æã™ã‚‹é–¢æ•°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€å¼•ç”¨ç¬¦å¯¾å¿œï¼‰
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }
    
    // CSVãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadCSV() {
      const fileInput = document.getElementById('csv-file');
      const statusDiv = document.getElementById('file-status');
      
      try {
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
          statusDiv.innerHTML = '<div class="text-blue-600">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
          
          const file = fileInput.files[0];
          console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:', file.name, 'ã‚µã‚¤ã‚º:', file.size, 'bytes');
          
          const csvText = await file.text();
          console.log('ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®æœ€åˆã®éƒ¨åˆ†:', csvText.substring(0, 200));
          
          if (!csvText.trim()) {
            throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
          }
          
          parseCSV(csvText);
          return;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒãªã„å ´åˆã®å‡¦ç†
        statusDiv.innerHTML = '<div class="text-yellow-600">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        
      } catch (error) {
        console.error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        statusDiv.innerHTML = `
          <div class="text-red-600">
            <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
            <p class="mt-2">ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
            <ul class="list-disc list-inside text-sm mt-1">
              <li>ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹</li>
              <li>ãƒ•ã‚¡ã‚¤ãƒ«ãŒCSVå½¢å¼ã‹</li>
              <li>ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ãªã„ã‹</li>
            </ul>
          </div>
        `;
      }
    }
    
    function parseCSV(csvText) {
      const statusDiv = document.getElementById('file-status');
      
      try {
        statusDiv.innerHTML = '<div class="text-blue-600">ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...</div>';
        
        // ç‹¬è‡ªã®CSVè§£æé–¢æ•°ã‚’ä½¿ç”¨
        const results = parseCSVText(csvText);
        
        console.log('CSVè§£æçµæœ:', results);
        console.log('ãƒ˜ãƒƒãƒ€ãƒ¼:', results.meta.fields);
        console.log('ç·ãƒ‡ãƒ¼ã‚¿æ•°:', results.data.length);
        
        if (!results.data || results.data.length === 0) {
          throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆç•ªå·ãŒã‚ã‚‹ã‚‚ã®ã®ã¿ï¼‰
        const validData = results.data.filter(row => {
          const hasNumber = row['ç•ªå·'] !== null && row['ç•ªå·'] !== undefined && row['ç•ªå·'] !== '';
          return hasNumber;
        });
        
        console.log('å…¨ãƒ‡ãƒ¼ã‚¿æ•°:', results.data.length);
        console.log('æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿æ•°:', validData.length);
        
        // å„ãƒ¡ãƒ¼ã‚«ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿æ•°ã‚’ãƒã‚§ãƒƒã‚¯
        const kansaiCount = validData.filter(row => row['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆè‰²å'] || row['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆå“ç•ª']).length;
        const rockCount = validData.filter(row => row['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆè‰²å'] || row['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆå“ç•ª']).length;
        const nipponCount = validData.filter(row => row['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆè‰²å'] || row['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆå“ç•ª']).length;
        const isamuCount = validData.filter(row => row['ã‚¤ã‚µãƒ å¡—æ–™è‰²å'] || row['ã‚¤ã‚µãƒ å¡—æ–™å“ç•ª']).length;
        
        if (validData.length === 0) {
          throw new Error('ã€Œç•ªå·ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        data = validData;
        statusDiv.innerHTML = `
          <div class="text-green-600">
            <p><strong>èª­ã¿è¾¼ã¿å®Œäº†!</strong></p>
            <p>ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${data.length} ä»¶</p>
            <div class="text-xs mt-1">
              <p>é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆ: ${kansaiCount}ä»¶ | ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆ: ${rockCount}ä»¶</p>
              <p>æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆ: ${nipponCount}ä»¶ | ã‚¤ã‚µãƒ å¡—æ–™: ${isamuCount}ä»¶</p>
            </div>
          </div>
        `;
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        window.debugData = data;
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€renderApp()ã‚’å‘¼ã³å‡ºã—
        renderApp();
        
      } catch (error) {
        console.error('CSVè§£æã‚¨ãƒ©ãƒ¼:', error);
        statusDiv.innerHTML = `
          <div class="text-red-600">
            <p><strong>è§£æã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
            <p class="text-xs mt-1">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
          </div>
        `;
      }
    }
    
    // è‰²åã‹ã‚‰è‰²ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
    function getColorFromName(colorName, category) {
      if (!colorName) return 'color-default';
      
      const name = colorName.toLowerCase();
      const cat = category ? category.toLowerCase() : '';
      
      if (name.includes('ãƒ¬ãƒƒãƒ‰') || name.includes('èµ¤') || name.includes('ãƒãƒ«ãƒ¼ãƒ³') || cat.includes('ãƒ¬ãƒƒãƒ‰')) return 'color-red';
      if (name.includes('ã‚ªãƒ¬ãƒ³ã‚¸') || name.includes('æ©™')) return 'color-orange';
      if (name.includes('ã‚¤ã‚¨ãƒ­ãƒ¼') || name.includes('é»„') || cat.includes('ã‚¤ã‚¨ãƒ­ãƒ¼')) return 'color-yellow';
      if (name.includes('ã‚°ãƒªãƒ¼ãƒ³') || name.includes('ç·‘') || cat.includes('ã‚°ãƒªãƒ¼ãƒ³')) return 'color-green';
      if (name.includes('ãƒ–ãƒ«ãƒ¼') || name.includes('é’') || cat.includes('ãƒ–ãƒ«ãƒ¼')) return 'color-blue';
      if (name.includes('ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆ') || name.includes('ç´«') || name.includes('ãƒ‘ãƒ¼ãƒ—ãƒ«') || cat.includes('ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆ')) return 'color-purple';
      if (name.includes('ãƒ”ãƒ³ã‚¯') || cat.includes('ãƒ”ãƒ³ã‚¯')) return 'color-pink';
      if (name.includes('ãƒ–ãƒ©ã‚¦ãƒ³') || name.includes('èŒ¶') || name.includes('ãƒ–ãƒ­ãƒ³ã‚º')) return 'color-brown';
      if (name.includes('ã‚°ãƒ¬ãƒ¼') || name.includes('ã‚°ãƒ¬ã‚¤') || name.includes('ç°')) return 'color-gray';
      if (name.includes('ãƒ–ãƒ©ãƒƒã‚¯') || name.includes('é»’')) return 'color-black';
      if (name.includes('ãƒ›ãƒ¯ã‚¤ãƒˆ') || name.includes('ç™½')) return 'color-white';
      
      return 'color-default';
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function closeModal() {
      const modal = document.getElementById('detail-modal');
      if (modal) {
        modal.classList.add('hidden');
        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
      }
    }
    
    // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–¢æ•°
    function handleColorClick(itemIndex, company) {
      console.log('handleColorClickå‘¼ã³å‡ºã—:', itemIndex, company);
      try {
        showDetailModal(itemIndex, company);
      } catch (error) {
        console.error('handleColorClickå†…ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã‹ã©ã†ã‹ã‚’åˆ¤å®š
    function isMobileView() {
      return window.innerWidth < 768;
    }
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderApp() {
      console.log('renderApp()é–‹å§‹ - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', data.length);
      
      const mobile = isMobileView();
      const categoryFilter = document.getElementById('category');
      const mobileResults = document.getElementById('mobile-results');
      
      if (!categoryFilter || !mobileResults) {
        console.error('å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ã‚«ãƒ†ã‚´ãƒªé¸æŠè‚¢ã‚’è¨­å®š
      const categories = [...new Set(data.map(item => item['ã‚«ãƒ†ã‚´ãƒª']).filter(Boolean))];
      categoryFilter.innerHTML = '<option value="">ã™ã¹ã¦</option>' + 
        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      
      // è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      if (mobile) {
        mobileResults.classList.remove('hidden');
        document.getElementById('desktop-container').classList.add('hidden');
      } else {
        mobileResults.classList.add('hidden');
        document.getElementById('desktop-container').classList.remove('hidden');
      }
      
      // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
      filterData();
    }
    
    // è‰²è¦ç´ ã‚’ä½œæˆ
    function createColorElement(item, index, company, mobile = false) {
      let companyName, colorName, productCode, characteristics;
      
      switch (company) {
        case 'kansai':
          companyName = 'é–¢è¥¿';
          colorName = item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆè‰²å'];
          productCode = item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'];
          characteristics = item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆã€€åŸè‰²ç‰¹æ€§'];
          break;
        case 'rock':
          companyName = 'ãƒ­ãƒƒã‚¯';
          colorName = item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆè‰²å'];
          productCode = item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'];
          characteristics = item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆã€€åŸè‰²ç‰¹æ€§'];
          break;
        case 'nippon':
          companyName = 'æ—¥æœ¬';
          colorName = item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆè‰²å'];
          productCode = item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'];
          characteristics = item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆã€€åŸè‰²ç‰¹æ€§'];
          break;
        case 'isamu':
          companyName = 'ã‚¤ã‚µãƒ ';
          colorName = item['ã‚¤ã‚µãƒ å¡—æ–™è‰²å'];
          productCode = item['ã‚¤ã‚µãƒ å¡—æ–™å“ç•ª'];
          characteristics = item['ã‚¤ã‚µãƒ å¡—æ–™ã€€åŸè‰²ç‰¹æ€§'];
          break;
      }
      
      // å“ç•ªã¨è‰²åã®ä¸¡æ–¹ã¾ãŸã¯ã©ã¡ã‚‰ã‹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¡¨ç¤ºã—ãªã„
      if (!productCode && !colorName) return '';
      
      // å“ç•ªã‚’æ–‡å­—åˆ—ã¨ã—ã¦è¡¨ç¤º
      const displayCode = productCode !== null && productCode !== undefined ? String(productCode) : '';
      const displayName = colorName || '';
      
      // åŸè‰²ç‰¹æ€§ãŒã‚ã‚‹ã‹ã©ã†ã‹ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
      const hasCharacteristics = characteristics && characteristics.trim() !== '';
      const characteristicsIcon = hasCharacteristics ? '<span class="text-blue-500 text-xs">â­</span>' : '';
      
      const colorClass = getColorFromName(colorName, item['ã‚«ãƒ†ã‚´ãƒª']);
      const clickHandler = `handleColorClick(${index}, '${company}')`;
      
      if (mobile) {
        return `
          <div class="flex items-center p-2 bg-gray-50 rounded clickable-color" onclick="${clickHandler}">
            <div class="w-6 h-6 rounded-full mr-2 ${colorClass}"></div>
            <div class="flex-1">
              <div class="font-medium flex items-center gap-1">
                ${companyName}: ${displayCode}
                ${characteristicsIcon}
              </div>
              <div class="text-xs text-gray-500">${displayName}</div>
            </div>
          </div>
        `;
      } else {
        return `
          <div class="flex items-center clickable-color" onclick="${clickHandler}">
            <div class="w-6 h-6 rounded-full mr-2 ${colorClass}"></div>
            <div>
              <div class="font-medium flex items-center gap-1">
                ${displayCode}
                ${characteristicsIcon}
              </div>
              <div class="text-sm text-gray-500">${displayName}</div>
            </div>
          </div>
        `;
      }
    }
    
    // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showDetailModal(itemIndex, company) {
      console.log('showDetailModalå‘¼ã³å‡ºã—:', itemIndex, company);
      
      try {
        const item = currentFilteredData[itemIndex];
        if (!item) {
          console.error('ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', itemIndex);
          return;
        }
        
        const modal = document.getElementById('detail-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        
        if (!modal || !modalTitle || !modalContent) {
          console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        let companyName, colorName, productCode, characteristics;
        
        switch (company) {
          case 'rock':
            companyName = 'ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆ';
            colorName = item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆè‰²å'];
            productCode = item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'];
            characteristics = item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆã€€åŸè‰²ç‰¹æ€§'];
            break;
          case 'kansai':
            companyName = 'é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆ';
            colorName = item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆè‰²å'];
            productCode = item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'];
            characteristics = item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆã€€åŸè‰²ç‰¹æ€§'];
            break;
          case 'nippon':
            companyName = 'æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆ';
            colorName = item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆè‰²å'];
            productCode = item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'];
            characteristics = item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆã€€åŸè‰²ç‰¹æ€§'];
            break;
          case 'isamu':
            companyName = 'ã‚¤ã‚µãƒ å¡—æ–™';
            colorName = item['ã‚¤ã‚µãƒ å¡—æ–™è‰²å'];
            productCode = item['ã‚¤ã‚µãƒ å¡—æ–™å“ç•ª'];
            characteristics = item['ã‚¤ã‚µãƒ å¡—æ–™ã€€åŸè‰²ç‰¹æ€§'];
            break;
          default:
            console.error('æœªçŸ¥ã®ãƒ¡ãƒ¼ã‚«ãƒ¼:', company);
            return;
        }
        
        modalTitle.textContent = `${companyName} - ${colorName || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}`;
        
        // å“ç•ªã‚’å®‰å…¨ã«è¡¨ç¤º
        const displayCode = productCode !== null && productCode !== undefined ? String(productCode) : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
        
        let content = `
          <div class="flex items-center mb-4">
            <div class="w-12 h-12 rounded-full mr-4 ${getColorFromName(colorName, item['ã‚«ãƒ†ã‚´ãƒª'])}"></div>
            <div>
              <h4 class="font-semibold text-lg">${colorName || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</h4>
              <p class="text-sm text-gray-600">å“ç•ª: ${displayCode}</p>
            </div>
          </div>
          
          <div class="mb-4">
            <p class="text-sm text-gray-600">ã‚«ãƒ†ã‚´ãƒª: ${item['ã‚«ãƒ†ã‚´ãƒª'] || ''}</p>
            <p class="text-sm text-gray-600">ç•ªå·: ${item['ç•ªå·'] || ''}</p>
          </div>
        `;
        
        if (characteristics) {
          const characteristicsList = characteristics.split(' | ').map(char => `<p>â€¢ ${char.trim()}</p>`).join('');
          content += `
            <div class="bg-blue-50 rounded-lg p-4">
              <h5 class="font-semibold text-gray-800 mb-2">åŸè‰²ç‰¹æ€§</h5>
              <div class="text-sm text-gray-700 space-y-1">
                ${characteristicsList}
              </div>
            </div>
          `;
        } else {
          content += `
            <div class="bg-gray-50 rounded-lg p-4">
              <p class="text-sm text-gray-600">ã“ã®è‰²ã®è©³ç´°ç‰¹æ€§ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
          `;
        }
        
        // äº’æ›è‰²æƒ…å ±ã‚’è¿½åŠ 
        const compatibleColors = [];
        if (item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆè‰²å'] && company !== 'kansai') {
          const kansaiCode = item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'] !== null && item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'] !== undefined ? String(item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆå“ç•ª']) : '';
          const kansaiChar = item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆã€€åŸè‰²ç‰¹æ€§'] ? ' â­' : '';
          compatibleColors.push(`é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆ: ${item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆè‰²å']} (${kansaiCode})${kansaiChar}`);
        }
        if (item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆè‰²å'] && company !== 'rock') {
          const rockCode = item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'] !== null && item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'] !== undefined ? String(item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆå“ç•ª']) : '';
          const rockChar = item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆã€€åŸè‰²ç‰¹æ€§'] ? ' â­' : '';
          compatibleColors.push(`ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆ: ${item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆè‰²å']} (${rockCode})${rockChar}`);
        }
        if (item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆè‰²å'] && company !== 'nippon') {
          const nipponCode = item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'] !== null && item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆå“ç•ª'] !== undefined ? String(item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆå“ç•ª']) : '';
          const nipponChar = item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆã€€åŸè‰²ç‰¹æ€§'] ? ' â­' : '';
          compatibleColors.push(`æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆ: ${item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆè‰²å']} (${nipponCode})${nipponChar}`);
        }
        if (item['ã‚¤ã‚µãƒ å¡—æ–™è‰²å'] && company !== 'isamu') {
          const isamuCode = item['ã‚¤ã‚µãƒ å¡—æ–™å“ç•ª'] !== null && item['ã‚¤ã‚µãƒ å¡—æ–™å“ç•ª'] !== undefined ? String(item['ã‚¤ã‚µãƒ å¡—æ–™å“ç•ª']) : '';
          const isamuChar = item['ã‚¤ã‚µãƒ å¡—æ–™ã€€åŸè‰²ç‰¹æ€§'] ? ' â­' : '';
          compatibleColors.push(`ã‚¤ã‚µãƒ å¡—æ–™: ${item['ã‚¤ã‚µãƒ å¡—æ–™è‰²å']} (${isamuCode})${isamuChar}`);
        }
        
        if (compatibleColors.length > 0) {
          const compatibleList = compatibleColors.map(color => `<p>â€¢ ${color}</p>`).join('');
          content += `
            <div class="mt-4 bg-green-50 rounded-lg p-4">
              <h5 class="font-semibold text-gray-800 mb-2">äº’æ›è‰²</h5>
              <div class="text-sm text-gray-700 space-y-1">
                ${compatibleList}
              </div>
              <p class="text-xs text-gray-500 mt-2">â­ = åŸè‰²ç‰¹æ€§ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š</p>
            </div>
          `;
        }
        
        modalContent.innerHTML = content;
        modal.classList.remove('hidden');
        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå®Œäº†');
        
      } catch (error) {
        console.error('showDetailModalå†…ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterData() {
      const mobile = isMobileView();
      const searchInput = document.getElementById('search');
      const categoryFilter = document.getElementById('category');
      const companyFilter = document.getElementById('company');
      const resultCount = document.getElementById('result-count');
      const noResults = document.getElementById('no-results');
      const mobileResults = document.getElementById('mobile-results');
      const resultTable = document.getElementById('result-table');
      
      const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
      const selectedCategory = categoryFilter ? categoryFilter.value : '';
      const selectedCompany = companyFilter ? companyFilter.value : '';
      
      let filtered = data;
      
      if (selectedCategory) {
        filtered = filtered.filter(item => item['ã‚«ãƒ†ã‚´ãƒª'] === selectedCategory);
      }
      
      if (selectedCompany) {
        let companyCodeField, companyNameField;
        
        switch (selectedCompany) {
          case 'kansai':
            companyCodeField = 'é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆå“ç•ª';
            companyNameField = 'é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆè‰²å';
            break;
          case 'rock':
            companyCodeField = 'ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆå“ç•ª';
            companyNameField = 'ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆè‰²å';
            break;
          case 'nippon':
            companyCodeField = 'æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆå“ç•ª';
            companyNameField = 'æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆè‰²å';
            break;
          case 'isamu':
            companyCodeField = 'ã‚¤ã‚µãƒ å¡—æ–™å“ç•ª';
            companyNameField = 'ã‚¤ã‚µãƒ å¡—æ–™è‰²å';
            break;
        }
        
        filtered = filtered.filter(item => {
          return (item[companyCodeField] !== null && item[companyCodeField] !== undefined) || 
                 (item[companyNameField] !== null && item[companyNameField] !== undefined && item[companyNameField] !== '');
        });
      }
      
      if (searchTerm) {
        filtered = filtered.filter(item => {
          const safeString = (value) => {
            if (value === null || value === undefined) return '';
            return String(value).toLowerCase();
          };
          
          return (
            safeString(item['ã‚«ãƒ†ã‚´ãƒª']).includes(searchTerm) ||
            safeString(item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆå“ç•ª']).includes(searchTerm) ||
            safeString(item['é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆè‰²å']).includes(searchTerm) ||
            safeString(item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆå“ç•ª']).includes(searchTerm) ||
            safeString(item['ãƒ­ãƒƒã‚¯ãƒšã‚¤ãƒ³ãƒˆè‰²å']).includes(searchTerm) ||
            safeString(item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆå“ç•ª']).includes(searchTerm) ||
            safeString(item['æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆè‰²å']).includes(searchTerm) ||
            safeString(item['ã‚¤ã‚µãƒ å¡—æ–™å“ç•ª']).includes(searchTerm) ||
            safeString(item['ã‚¤ã‚µãƒ å¡—æ–™è‰²å']).includes(searchTerm) ||
            safeString(item['ç•ªå·']).includes(searchTerm)
          );
        });
      }
      
      currentFilteredData = filtered;
      if (resultCount) resultCount.textContent = `æ¤œç´¢çµæœ: ${filtered.length} ä»¶`;
      
      if (filtered.length === 0) {
        if (mobile && mobileResults) mobileResults.innerHTML = '';
        if (resultTable) resultTable.innerHTML = '';
        if (noResults) noResults.classList.remove('hidden');
      } else {
        if (noResults) noResults.classList.add('hidden');
        
        if (mobile && mobileResults) {
          mobileResults.innerHTML = filtered.map((item, index) => `
            <div class="bg-white rounded-lg shadow p-3 border border-gray-100">
              <div class="flex justify-between items-start mb-2">
                <div class="text-sm text-gray-500">${item['ã‚«ãƒ†ã‚´ãƒª'] || ''}</div>
                <div class="text-xs bg-gray-100 rounded px-2 py-1">No.${item['ç•ªå·'] || ''}</div>
              </div>
              
              <div class="grid grid-cols-1 gap-2">
                ${createColorElement(item, index, 'kansai', true)}
                ${createColorElement(item, index, 'rock', true)}
                ${createColorElement(item, index, 'nippon', true)}
                ${createColorElement(item, index, 'isamu', true)}
              </div>
            </div>
          `).join('');
        } else if (resultTable) {
          resultTable.innerHTML = filtered.map((item, index) => `
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-2 whitespace-nowrap">${item['ç•ªå·'] || ''}</td>
              <td class="px-4 py-2 whitespace-nowrap">${item['ã‚«ãƒ†ã‚´ãƒª'] || ''}</td>
              <td class="px-4 py-2">${createColorElement(item, index, 'kansai', false)}</td>
              <td class="px-4 py-2">${createColorElement(item, index, 'rock', false)}</td>
              <td class="px-4 py-2">${createColorElement(item, index, 'nippon', false)}</td>
              <td class="px-4 py-2">${createColorElement(item, index, 'isamu', false)}</td>
            </tr>
          `).join('');
        }
      }
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦ç™»éŒ²
    window.handleColorClick = handleColorClick;
    
    // DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMèª­ã¿è¾¼ã¿å®Œäº†');
      
      const elements = {
        searchInput: document.getElementById('search'),
        categoryFilter: document.getElementById('category'),
        companyFilter: document.getElementById('company'),
        csvFileInput: document.getElementById('csv-file'),
        closeModalBtn: document.getElementById('close-modal'),
        modal: document.getElementById('detail-modal')
      };
      
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
      if (elements.csvFileInput) {
        elements.csvFileInput.addEventListener('change', function(event) {
          console.log('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ');
          if (this.files && this.files.length > 0) {
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', this.files[0].name);
            loadCSV();
          }
        });
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      if (elements.closeModalBtn) {
        elements.closeModalBtn.addEventListener('click', closeModal);
      }
      
      if (elements.modal) {
        elements.modal.addEventListener('click', function(e) {
          if (e.target === elements.modal) {
            closeModal();
          }
        });
      }
      
      // Escapeã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
      if (elements.searchInput) {
        elements.searchInput.addEventListener('input', filterData);
      }
      if (elements.categoryFilter) {
        elements.categoryFilter.addEventListener('change', filterData);
      }
      if (elements.companyFilter) {
        elements.companyFilter.addEventListener('change', filterData);
      }
      
      // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®å‡¦ç†
      window.addEventListener('resize', () => {
        if (data.length > 0) {
          renderApp();
        }
      });
      
      // åˆæœŸè¡¨ç¤º
      const statusDiv = document.getElementById('file-status');
      if (statusDiv) {
        statusDiv.innerHTML = `
          <div class="text-gray-600">
            <p>ğŸ“‹ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <p class="text-xs mt-1">å¯¾å¿œå½¢å¼: CSV (.csv)</p>
            <p class="text-xs text-blue-600">ğŸ’¡ æ–°å½¢å¼ã§ã¯å…¨ãƒ¡ãƒ¼ã‚«ãƒ¼ã®åŸè‰²ç‰¹æ€§ã«å¯¾å¿œã—ã¦ã„ã¾ã™</p>
          </div>
        `;
      }
    });
    
    // Service Workerã®ç™»éŒ²
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service WorkerãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸ', registration.scope);
          })
          .catch(error => {
            console.log('Service Workerç™»éŒ²å¤±æ•—:', error);
          });
      });
    }
  </script>
</body>
</html>