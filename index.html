 companyCodeField, companyNameField;
            
            switch (selectedCompany) {
              case 'kansai':
                companyCodeField = '関西ペイント品番';
                companyNameField = '関西ペイント色名';
                break;
              case 'rock':
                companyCodeField = 'ロックペイント品番';
                companyNameField = 'ロックペイント色名';
                break;
              case 'nippon':
                companyCodeField = '日本ペイント品番';
                companyNameField = '日本ペイント色名';
                break;
              case 'isamu':
                companyCodeField = 'イサム塗料品番';
                companyNameField = 'イサム塗料色名';
                break;
            }
            
            filtered = filtered.filter(item => 
              item[companyCodeField] || item[companyNameField]
            );
          }
          
          // 検索語でフィルタリング
          if (searchTerm) {
            filtered = filtered.filter(item => {
              return (
                (item['カテゴリ'] && String(item['カテゴリ']).toLowerCase().includes(searchTerm)) ||
                (item['関西ペイント品番'] && String(item['関西ペイント品番']).toLowerCase().includes(searchTerm)) ||
                (item['関西ペイント色名'] && String(item['関西ペイント色名']).toLowerCase().includes(searchTerm)) ||
                (item['ロックペイント品番'] && String(item['ロックペイント品番']).toLowerCase().includes(searchTerm)) ||
                (item['ロックペイント色名'] && String(item['ロックペイント色名']).toLowerCase().includes(searchTerm)) ||
                (item['日本ペイント品番'] && String(item['日本ペイント品番']).toLowerCase().includes(searchTerm)) ||
                (item['日本ペイント色名'] && String(item['日本ペイント色名']).toLowerCase().includes(searchTerm)) ||
                (item['イサム塗料品番'] && String(item['イサム塗料品番']).toLowerCase().includes(searchTerm)) ||
                (item['イサム塗料色名'] && String(item['イサム塗料色名']).toLowerCase().includes(searchTerm)) ||
                (item['番号'] && String(item['番号']).toLowerCase().includes(searchTerm))
              );
            });
          }
          
          // 結果を表示
          resultCount.textContent = `検索結果: ${filtered.length} 件`;
          
          if (filtered.length === 0) {
            if (mobile && mobileResults) mobileResults.innerHTML = '';
            if (resultTable) resultTable.innerHTML = '';
            noResults.classList.remove('hidden');
          } else {
            noResults.classList.add('hidden');
            
            if (mobile && mobileResults) {
              mobileResults.innerHTML = filtered.map((item, index) => `
                <div class="bg-white rounded-lg shadow p-3 border border-gray-100">
                  <div class="flex justify-between items-start mb-2">
                    <div class="text-sm text-gray-500">${item['カテゴリ'] || ''}</div>
                    <div class="text-xs bg-gray-100 rounded px-2 py-1">No.${item['番号'] || ''}</div>
                  </div>
                  
                  <div class="grid grid-cols-1 gap-2">
                    ${item['関西ペイント品番'] ? `
                      <div class="flex items-center p-2 bg-gray-50 rounded">
                        <div class="w-6 h-6 rounded-full mr-2 ${getColorFromName(item['関西ペイント色名'], item['カテゴリ'])}"></div>
                        <div>
                          <div class="font-medium">関西: ${item['関西ペイント品番']}</div>
                          <div class="text-xs text-gray-500">${item['関西ペイント色名'] || ''}</div>
                        </div>
                      </div>
                    ` : ''}
                    
                    ${item['ロックペイント品番'] ? `
                      <div class="flex items-center p-2 bg-gray-50 rounded">
                        <div class="w-6 h-6 rounded-full mr-2 ${getColorFromName(item['ロックペイント色名'], item['カテゴリ'])}"></div>
                        <div>
                          <div class="font-medium">ロック: ${item['ロックペイント品番']}</div>
                          <div class="text-xs text-gray-500">${item['ロックペイント色名'] || ''}</div>
                        </div>
                      </div>
                    ` : ''}
                    
                    ${item['日本ペイント品番'] ? `
                      <div class="flex items-center p-2 bg-gray-50 rounded">
                        <div class="w-6 h-6 rounded-full mr-2 ${getColorFromName(item['日本ペイント色名'], item['カテゴリ'])}"></div>
                        <div>
                          <div class="font-medium">日本: ${item['日本ペイント品番']}</div>
                          <div class="text-xs text-gray-500">${item['日本ペイント色名'] || ''}</div>
                        </div>
                      </div>
                    ` : ''}
                    
                    ${item['イサム塗料品番'] ? `
                      <div class="flex items-center p-2 bg-gray-50 rounded">
                        <div class="w-6 h-6 rounded-full mr-2 ${getColorFromName(item['イサム塗料色名'], item['カテゴリ'])}"></div>
                        <div>
                          <div class="font-medium">イサム: ${item['イサム塗料品番']}</div>
                          <div class="text-xs text-gray-500">${item['イサム塗料色名'] || ''}</div>
                        </div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              `).join('')}
            } else if (resultTable) {
              resultTable.innerHTML = filtered.map((item, index) => `
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2 whitespace-nowrap">${item['番号'] || ''}</td>
                  <td class="px-4 py-2 whitespace-nowrap">${item['カテゴリ'] || ''}</td>
                  
                  <td class="px-4 py-2">
                    <div class="flex items-center">
                      ${item['関西ペイント品番'] ? `
                        <div class="w-6 h-6 rounded-full mr-2 ${getColorFromName(item['関西ペイント色名'], item['カテゴリ'])}"></div>
                        <div>
                          <div class="font-medium">${item['関西ペイント品番']}</div>
                          <div class="text-sm text-gray-500">${item['関西ペイント色名'] || ''}</div>
                        </div>
                      ` : ''}
                    </div>
                  </td>
                  
                  <td class="px-4 py-2">
                    <div class="flex items-center">
                      ${item['ロックペイント品番'] ? `
                        <div class="w-6 h-6 rounded-full mr-2 ${getColorFromName(item['ロックペイント色名'], item['カテゴリ'])}"></div>
                        <div>
                          <div class="font-medium">${item['ロックペイント品番']}</div>
                          <div class="text-sm text-gray-500">${item['ロックペイント色名'] || ''}</div>
                        </div>
                      ` : ''}
                    </div>
                  </td>
                  
                  <td class="px-4 py-2">
                    <div class="flex items-center">
                      ${item['日本ペイント品番'] ? `
                        <div class="w-6 h-6 rounded-full mr-2 ${getColorFromName(item['日本ペイント色名'], item['カテゴリ'])}"></div>
                        <div>
                          <div class="font-medium">${item['日本ペイント品番']}</div>
                          <div class="text-sm text-gray-500">${item['日本ペイント色名'] || ''}</div>
                        </div>
                      ` : ''}
                    </div>
                  </td>
                  
                  <td class="px-4 py-2">
                    <div class="flex items-center">
                      ${item['イサム塗料品番'] ? `
                        <div class="w-6 h-6 rounded-full mr-2 ${getColorFromName(item['イサム塗料色名'], item['カテゴリ'])}"></div>
                        <div>
                          <div class="font-medium">${item['イサム塗料品番']}</div>
                          <div class="text-sm text-gray-500">${item['イサム塗料色名'] || ''}</div>
                        </div>
                      ` : ''}
                    </div>
                  </td>
                </tr>
              `).join('')}
            }
          }
        }
        
        // イベントリスナーの設定
        if (searchInput) searchInput.addEventListener('input', filterData);
        if (categoryFilter) categoryFilter.addEventListener('change', filterData);
        if (companyFilter) companyFilter.addEventListener('change', filterData);
        
        // ウィンドウサイズ変更時の処理
        window.addEventListener('resize', () => {
          const currentMobile = isMobileView();
          if (mobile !== currentMobile) {
            // モバイル表示/PC表示の切り替えが発生した場合に再レンダリング
            renderApp(data);
          }
        });
      }
      
      // アプリを起動
      loadCSV();
    });
    
    // Service Workerの登録
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Workerが登録されました', registration.scope);
          })
          .catch(error => {
            console.log('Service Worker登録失敗:', error);
          });
      });
    }
  </script>
</body>
</html>